name: Build and Test - Windows

on:
  workflow_call:
    outputs:
      artifact-name:
        description: "The name of the Windows artifact"
        value: ${{ jobs.build-windows.outputs.artifact-name }}
      version:
        description: "The version being built"
        value: ${{ jobs.build-windows.outputs.version }}
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    outputs:
      artifact-name: ${{ steps.artifact-info.outputs.artifact-name }}
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Read version
      id: version
      shell: pwsh
      run: |
        $VERSION = Get-Content VERSION -Raw
        $VERSION = $VERSION.Trim()
        echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
        Write-Host "Building version: $VERSION"

    - name: Install dependencies
      run: go mod tidy

    - name: Build binary with version
      shell: pwsh
      run: |
        $VERSION = (Get-Content VERSION).Trim()
        go build -ldflags="-X main.Version=$VERSION -s -w" -o pgn_check.exe
        Write-Host "Binary built successfully"

    - name: Verify version
      shell: pwsh
      run: |
        .\pgn_check.exe --version
        Write-Host "Version verified"

    - name: Run tests
      run: |
        Write-Host "Running Go tests..."
        go test -v ./...

    - name: Run benchmarks
      shell: pwsh
      run: |
        Write-Host "Running performance benchmarks..."
        
        # Create test output directory
        New-Item -ItemType Directory -Force -Path benchmark_results | Out-Null
        
        # Run benchmark and save results
        .\benchmark.ps1 *> benchmark_results\benchmark_output.txt
        
        Write-Host "Benchmark completed. Results:"
        Get-Content benchmark_results\benchmark_output.txt

    - name: Create artifact directory
      id: artifact-info
      shell: pwsh
      run: |
        $VERSION = (Get-Content VERSION).Trim()
        $ARTIFACT_NAME = "pgn_check-windows-v$VERSION"
        
        New-Item -ItemType Directory -Force -Path $ARTIFACT_NAME | Out-Null
        
        echo "artifact-name=$ARTIFACT_NAME" >> $env:GITHUB_OUTPUT
        
        # Copy binary
        Copy-Item pgn_check.exe "$ARTIFACT_NAME\"
        
        # Copy version file
        Copy-Item VERSION "$ARTIFACT_NAME\"
        
        # Copy LICENSE file
        Copy-Item LICENSE "$ARTIFACT_NAME\"
        
        # Create README for artifact
        "PGN Check - Windows Build" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8
        "Version: $VERSION" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "Built: $(Get-Date)" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "Platform: Windows x64" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "Author: Nazario D'Apote" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "Email: nazario [dot] dapote [at] gmail [dot] com" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "License: MIT (see LICENSE file)" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "Usage:" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "  pgn_check.exe <file.pgn>" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "  pgn_check.exe -o output.pgn input.pgn" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "  pgn_check.exe --version" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "" | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        "For more information, see the main repository." | Out-File -FilePath "$ARTIFACT_NAME\README.txt" -Encoding utf8 -Append
        
        # Copy benchmark results if available
        if (Test-Path benchmark_results\benchmark_output.txt) {
          Copy-Item benchmark_results\benchmark_output.txt "$ARTIFACT_NAME\"
        }
        
        # Create zip archive
        Compress-Archive -Path $ARTIFACT_NAME -DestinationPath "$ARTIFACT_NAME.zip" -Force
        
        echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $env:GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pgn_check-windows-v${{ steps.version.outputs.VERSION }}
        path: |
          pgn_check-windows-v${{ steps.version.outputs.VERSION }}.zip
          pgn_check-windows-v${{ steps.version.outputs.VERSION }}/
        retention-days: 90

    - name: Display artifact info
      shell: pwsh
      run: |
        $VERSION = (Get-Content VERSION).Trim()
        Write-Host "================================"
        Write-Host "Build completed successfully!"
        Write-Host "================================"
        Write-Host "Version: $VERSION"
        Write-Host "Platform: Windows"
        Write-Host "Artifact: pgn_check-windows-v$VERSION.zip"
        Get-Item "pgn_check-windows-v$VERSION.zip" | Select-Object Name, Length
